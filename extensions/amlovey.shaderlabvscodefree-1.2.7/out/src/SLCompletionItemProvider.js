"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const vscode_1=require("vscode"),functionsConfig=require("./data/functions.json"),keywordsConfig=require("./data/keywords.json"),Utilities_1=require("./Utilities"),functions=functionsConfig,keywords=keywordsConfig;class ShaderlabCompletionItemProvider{provideCompletionItems(t,e,i){let o=t.lineAt(e).text.charAt(e.character-1),r=[];return this.isInIncludeLine(t,e)?"/"!=o&&"\\"!=o||(r=this.getInclideCompletion(t,e)):r=this.getNormalCaseSet(t),Promise.resolve(r)}isInIncludeLine(t,e){var i=t.lineAt(e).text;return/#include\s*?\"[\s\S]+?\"/.test(i)}getInclideCompletion(t,e){var i=t.lineAt(e).text,o=Utilities_1.default.getIncludeFiles(i)[0],r=Utilities_1.default.translatePackagePath(t.uri,o),n=[];return Utilities_1.default.getFiles(r).filter(t=>!t.startsWith(".")&&!t.endsWith(".meta")).forEach(t=>{console.log(t);var e=Utilities_1.default.join(r,t),i=Utilities_1.default.IsFolder(e),o=t;i&&(o=o.replace(/@[0-9a-zA-Z_\.-]+/,"")),n.push(this.getCompletionProposal(o,t,"",i?vscode_1.CompletionItemKind.Folder:vscode_1.CompletionItemKind.File))}),n}getNormalCaseSet(t){let e=[];for(var i in functions.Items){o=functions.Items[i];e.push(this.getCompletionProposal(i,o.detail,o.documentation,functions.ItemKind))}for(var i in keywords.Items){var o=keywords.Items[i];for(var r in o){let t=o[r];t&&e.push(this.getCompletionProposal(t,"","",keywords.ItemKind))}}let n=t.getText();e=e.concat(this.getMethodInfo(n));let l=Utilities_1.default.getIncludeFilesContent(n,t.uri);l.forEach(t=>{e=e.concat(this.getMethodInfo(t))}),e=e.concat(this.getPropertiesInfo(n));var s=this.getStructuresInfo(n);e=e.concat(s),l.forEach(t=>{s=s.concat(this.getStructuresInfo(t)),e=e.concat(this.getStructuresInfo(t))});let a=[];return s.forEach(t=>{t&&a.push(t.label)}),e=e.concat(this.getVariablesInfo(n,a.join("|")))}getVariablesInfo(t,e){let i=[],o=Utilities_1.default.getVariablesFromCode(t,e);for(var r in o){let t=o[r];if(t){let e=t.substring(0,t.length-1).split(" ",2);if(2==e.length){let t=e[0].trim(),o=e[1].trim();i.push(this.getCompletionProposal(o,t,"",vscode_1.CompletionItemKind.Variable))}}}return i}getPropertiesInfo(t){return this.getCompletionItemFromMatchResult(t,Utilities_1.default.getPropertiesDefinationFromCode,t=>{let e=t.replace(/\(/gi,",").replace(/\)/gi,",").split(",");if(e.length>=4)return this.getCompletionProposal(e[0].trim(),e[2].trim(),"",vscode_1.CompletionItemKind.Property)})}getStructuresInfo(t){return this.getCompletionItemFromMatchResult(t,Utilities_1.default.getStructDefinationFromCode,t=>{let e=t.substring(6,t.length-7).split("{");if(e.length>=2)return this.getCompletionProposal(e[0].trim(),"struct","",vscode_1.CompletionItemKind.Struct)})}getMethodInfo(t){return this.getCompletionItemFromMatchResult(t,Utilities_1.default.getMethodCodeLineFromCode,t=>{let e=Utilities_1.default.getMethodNameFromSignatureCode(t);if(e)return this.getCompletionProposal(e,"",t.substring(0,t.length-1).trim(),vscode_1.CompletionItemKind.Method)})}getCompletionItemFromMatchResult(t,e,i){let o=[],r=e(t);for(var n in r){let t=r[n];if(t){let e=i(t);e&&o.push(i(t))}}return o}getCompletionProposal(t,e,i,o){let r=new vscode_1.CompletionItem(t,o);return r.detail=e,r.documentation=i,r}}ShaderlabCompletionItemProvider.triggerCharacters=["\\","/"],exports.default=ShaderlabCompletionItemProvider;