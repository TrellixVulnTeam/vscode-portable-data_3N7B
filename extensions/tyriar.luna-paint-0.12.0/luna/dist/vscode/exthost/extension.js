var b=(o,t)=>()=>(t||o((t={exports:{}}).exports,t),t.exports);var B=b(m=>{"use strict";var U;Object.defineProperty(m,"__esModule",{value:!0});m.isLinux=m.isWindows=m.isMac=m.isWeb=m.globals=void 0;m.globals=typeof self=="object"?self:typeof global=="object"?global:{};var y;typeof m.globals.vscode!="undefined"&&typeof m.globals.vscode.process!="undefined"?y=m.globals.vscode.process:typeof process!="undefined"&&(y=process);var Se=typeof((U=y==null?void 0:y.versions)===null||U===void 0?void 0:U.electron)=="string"&&y.type==="renderer",j=!1,P=!1,z=!1,L=!1;typeof navigator=="object"&&!Se?(j=!0,z=navigator.userAgent.indexOf("Windows")>=0,P=navigator.userAgent.indexOf("Macintosh")>=0,L=navigator.userAgent.indexOf("Linux")>=0):typeof y=="object"&&(j=!1,z=y.platform==="win32",P=y.platform==="darwin",L=y.platform==="linux");m.isWeb=j;m.isMac=P;m.isWindows=z;m.isLinux=L});var W=b(S=>{"use strict";Object.defineProperty(S,"__esModule",{value:!0});S.mixinGlobalState=S.getWorkbenchState=S.getGlobalState=void 0;function G(o,t){let e=o.workspaceState.get("workbenchState"),i=e==null?void 0:e[t];return!i||i.version!==3?{version:3,entries:[]}:i}function $(o){return G(o,"global")}S.getGlobalState=$;function Ce(o,t){let e=G(o,t.toString());return V(o,e),e}S.getWorkbenchState=Ce;function V(o,t){let e=$(o);for(let i of e.entries){let n=t.entries.findIndex(s=>s.id===i.id);t.entries.splice(n,1)}t.entries.push(...e.entries)}S.mixinGlobalState=V});var F=b(C=>{"use strict";var J=C&&C.__awaiter||function(o,t,e,i){function n(s){return s instanceof e?s:new e(function(a){a(s)})}return new(e||(e=Promise))(function(s,a){function d(c){try{h(i.next(c))}catch(p){a(p)}}function f(c){try{h(i.throw(c))}catch(p){a(p)}}function h(c){c.done?s(c.value):n(c.value).then(d,f)}h((i=i.apply(o,t||[])).next())})};Object.defineProperty(C,"__esModule",{value:!0});C.saveBackupData=C.getBackupData=void 0;var K=require("vscode"),Q=B(),Ie=W();function xe(o,t){return J(this,void 0,void 0,function*(){let e=yield K.workspace.fs.readFile(t);if(Q.isWeb){if(!self.TextDecoder)return console.warn("This browser doesn't support TextEncoder"),{};let f=new self.TextDecoder().decode(e),h=X(f==null?void 0:f.state),c=f==null?void 0:f.workbenchState;return{state:h,workbenchState:c}}let n=new(yield Promise.resolve().then(()=>require("v8"))).Deserializer(e).readValue(),s=X(n==null?void 0:n.state),a=n==null?void 0:n.workbenchState;return(0,Ie.mixinGlobalState)(o,a),{state:s,workbenchState:a}})}C.getBackupData=xe;function ke(o,t){return J(this,void 0,void 0,function*(){let e;if(Q.isWeb)if(self.TextEncoder)e=new self.TextEncoder().encode(JSON.stringify(t));else throw new Error("This browser doesn't support TextEncoder");else{let i=new(yield Promise.resolve().then(()=>require("v8"))).Serializer;i.writeValue(t),e=i.releaseBuffer()}yield K.workspace.fs.writeFile(o,e)})}C.saveBackupData=ke;function X(o){if(typeof o!="object"||o===null)return;let t=o;if(!(!("version"in t)||t.version!==8)&&("body"in t||typeof t.body!="object"))return{version:t.version,body:t.body}}});var Z=b(x=>{"use strict";Object.defineProperty(x,"__esModule",{value:!0});x.deserializeFromJson=x.serializeToJson=void 0;function Y(o){if(!o||typeof o!="object")return o;let t={};for(let e of Object.keys(o)){let i=o[e];typeof i=="object"?"readyPromise"in i?t[e]=De(i):i instanceof Float32Array?t[e]=R(i,"Float32Array"):i instanceof Uint8Array?t[e]=R(i,"Uint8Array"):i instanceof Uint16Array?t[e]=R(i,"Uint16Array"):i instanceof Uint32Array?t[e]=R(i,"Uint32Array"):t[e]=i:t[e]=i}return t}x.serializeToJson=Y;function N(o){if(!o||typeof o!="object")return o;let t={};for(let e of Object.keys(o)){let i=o[e];typeof i=="object"?"dataType"in i?i.dataType==="pending"?t[e]=qe(i):t[e]=Be(i):t[e]=N(i):t[e]=i}return t}x.deserializeFromJson=N;function De(o){return{dataType:"pending",data:Y(o.resource)}}function qe(o){let t=N(o.data);return{resource:t,readyPromise:Promise.resolve(t),isReady:!0}}function R(o,t){return{dataType:t,data:Array.from(o)}}function Be(o){return new global[o.dataType](o.data)}});var se=b(k=>{"use strict";var ee=k&&k.__awaiter||function(o,t,e,i){function n(s){return s instanceof e?s:new e(function(a){a(s)})}return new(e||(e=Promise))(function(s,a){function d(c){try{h(i.next(c))}catch(p){a(p)}}function f(c){try{h(i.throw(c))}catch(p){a(p)}}function h(c){c.done?s(c.value):n(c.value).then(d,f)}h((i=i.apply(o,t||[])).next())})};Object.defineProperty(k,"__esModule",{value:!0});k.WebviewIpcClient=void 0;var te=Z(),ie=B(),ne=class{constructor(t){this._webview=t,this._webviewRequestHandlers=new Map,this._activeRequests=new Map,this._webview.onDidReceiveMessage(e=>ee(this,void 0,void 0,function*(){if("extHostRequestId"in e){let i=e.extHostRequestId,n=this._activeRequests.get(i);if(!n)throw new Error(`Response received without request "${i}"`);this._activeRequests.delete(i),n(ie.isWeb?(0,te.deserializeFromJson)(e.body):e.body);return}if("webviewRequestId"in e){let i=this._webviewRequestHandlers.get(e.type);if(!i)throw new Error(`No handler for webview request "${e.type}"`);let n=yield i(e.body),s={type:e.type,body:ie.isWeb?(0,te.serializeToJson)(n):n,webviewRequestId:e.webviewRequestId};this._webview.postMessage(s);return}}))}registerRequestHandler(t,e){if(this._webviewRequestHandlers.has(t))throw new Error(`Duplicate webview request handler "${t}"`);this._webviewRequestHandlers.set(t,e)}request(t,e){return ee(this,void 0,void 0,function*(){let i=Math.round(Math.random()*1e6);return yield new Promise(s=>{this._activeRequests.set(i,s);let a={type:t,body:e,extHostRequestId:i};this._webview.postMessage(a)})})}};k.WebviewIpcClient=ne});var ae=b(D=>{"use strict";Object.defineProperty(D,"__esModule",{value:!0});D.disposeArray=D.Disposable=void 0;var oe=class{constructor(){this._disposables=[],this._isDisposed=!1}dispose(){if(this._isDisposed)throw new Error("Attempt to dispose a disposed entity");this._isDisposed=!0;for(let t of this._disposables)t.dispose();this._disposables.length=0}register(t){return this._disposables.push(t),t}unregister(t){let e=this._disposables.indexOf(t);e!==-1&&this._disposables.splice(e,1)}};D.Disposable=oe;function Ee(o){for(let t of o)t.dispose();o.length=0}D.disposeArray=Ee});var H=b(T=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0});T.perf=void 0;var We=B();T.perf=We.isWeb?self.performance:require("perf_hooks").performance});var me=b(w=>{"use strict";var l=w&&w.__awaiter||function(o,t,e,i){function n(s){return s instanceof e?s:new e(function(a){a(s)})}return new(e||(e=Promise))(function(s,a){function d(c){try{h(i.next(c))}catch(p){a(p)}}function f(c){try{h(i.throw(c))}catch(p){a(p)}}function h(c){c.done?s(c.value):n(c.value).then(d,f)}h((i=i.apply(o,t||[])).next())})};Object.defineProperty(w,"__esModule",{value:!0});w.setVscodeContext=w.BuiltInCommands=w.ImageDocument=void 0;var Re=require("path"),u=require("vscode"),re=F(),Te=se(),ce=ae(),g=H(),ue=W(),de=class extends ce.Disposable{constructor(t,e,i,n){var s;super();if(this._context=t,this.uri=e,this._initData=i,this._isInitialized=!1,this._editIndex=0,this._savedEditIndex=0,this._hasContentChanged=!1,this._fileWatcherDisposables=[],this._isActive=!1,this._globalState=new Map,this._workbenchState=new Map,this._perfMetrics={startEvent:0,webviewReadyEvent:0,dataReadyEvent:0,finishEvent:0,totalDuration:0,parseDuration:0,dataTransportDuration:0},this._onDisposed=new u.EventEmitter,this.onDisposed=this._onDisposed.event,this._onDidChange=new u.EventEmitter,this.onDidChange=this._onDidChange.event,this._onDidUpdateGlobalState=new u.EventEmitter,this.onDidUpdateGlobalState=this._onDidUpdateGlobalState.event,this._onRequestReload=new u.EventEmitter,this.onRequestReload=this._onRequestReload.event,this._onMimeTypeChange=new u.EventEmitter,this.onSetMimeType=this._onMimeTypeChange.event,((s=this._initData.workbenchState)===null||s===void 0?void 0:s.version)===3)for(let a of this._initData.workbenchState.entries)this._workbenchState.set(a.id,a.state);this._perfMetrics.startEvent=n!==void 0?n:g.perf.now(),this._setupFileWatcher(e)}get isActive(){return this._isActive}set isActive(t){this._isActive=t,this._isActive&&this._hasContentChanged&&this._showContentChangedWarning()}get _isDirty(){return this._editIndex!==this._savedEditIndex}dispose(){let t=this._context.workspaceState.get("workbenchState");t&&this.uri.toString()in t&&(delete t[this.uri.toString()],this._context.workspaceState.update("workbenchState",t)),this._onDisposed.fire(),super.dispose()}_setupFileWatcher(t){var e;if(((e=this._fileWatcherUri)===null||e===void 0?void 0:e.toString())===t.toString())return;this._fileWatcherUri=t,(0,ce.disposeArray)(this._fileWatcherDisposables);let i=u.workspace.createFileSystemWatcher(this._fileWatcherUri.fsPath);this._fileWatcherDisposables.push(i),this._fileWatcherDisposables.push(i.onDidChange(()=>l(this,void 0,void 0,function*(){return this._handleFileChangeEvent(t)}))),this._fileWatcherDisposables.push(i.onDidCreate(()=>l(this,void 0,void 0,function*(){return this._handleFileChangeEvent(t)})))}_handleFileChangeEvent(t){return l(this,void 0,void 0,function*(){let e=yield u.workspace.fs.stat(t);if(!(!this._lastSaveStat||Ae(e,yield this._lastSaveStat))){if(!this._isActive){this._hasContentChanged=!0;return}if(this._isDirty){yield this._showContentChangedWarning();return}this._onRequestReload.fire()}})}_showContentChangedWarning(){return l(this,void 0,void 0,function*(){(yield u.window.showWarningMessage("The image changed on disk, do you want to reload the file?","Reload"))==="Reload"&&(yield u.commands.executeCommand("workbench.action.files.revert"),this._onRequestReload.fire())})}save(t,e){return l(this,void 0,void 0,function*(){if(!this._isDirty){console.warn("Attempt to save when not dirty");return}yield this.saveAs(t,this.uri,e)})}saveAs(t,e,i){return l(this,void 0,void 0,function*(){let n={startEvent:g.perf.now(),writeStartEvent:0,writeFinishEvent:0,finishEvent:0,encodeDuration:0,dataTransportDuration:0,totalDuration:0},s=u.workspace.getConfiguration("files").get("autoSave")!=="off",a=yield t.request("save",{isAutoSaveEnabled:s});if(i.isCancellationRequested)return;n.encodeDuration=a.encodeDuration,n.writeStartEvent=g.perf.now(),n.dataTransportDuration=n.writeStartEvent-n.startEvent-n.encodeDuration;let d=new Uint8Array(a.blobBuffer);yield u.workspace.fs.writeFile(e,d),n.writeFinishEvent=g.perf.now(),this._lastSaveStat=u.workspace.fs.stat(e),yield this._lastSaveStat,this._setupFileWatcher(e),this._savedEditIndex=this._editIndex,this._latestBackupUri&&(yield u.workspace.fs.delete(this._latestBackupUri),this._latestBackupUri=void 0,this._latestBackupContent=void 0),n.finishEvent=g.perf.now(),n.totalDuration=n.finishEvent-n.startEvent,pe(`Save perf: ${this.uri.fsPath}`,n)})}revert(){this._latestBackupUri=void 0,this._lastSaveStat=void 0,this._editIndex=0,this._savedEditIndex=0,this._hasContentChanged=!1,this._isInitialized=!0}backup(t,e,i){return l(this,void 0,void 0,function*(){let n=u.workspace.getConfiguration().get("luna.hotExitMaxPixels",0),s=yield t.request("backup",{hotExitMaxPixels:n});if(i.isCancellationRequested)throw new Error("Backup canceled");if(!s.success)throw new Error("Could not backup file as it's too large");return yield(0,re.saveBackupData)(e.destination,{state:s.state,workbenchState:s.workbenchState}),this._latestBackupUri=e.destination,this._latestBackupContent=void 0,{id:e.destination.toString(),delete:()=>l(this,void 0,void 0,function*(){this._latestBackupUri&&this._latestBackupUri.toString()===e.destination.toString()&&(this._latestBackupContent=s.state);try{yield u.workspace.fs.delete(e.destination)}catch{}})}})}setupIpc(t){let e=new Te.WebviewIpcClient(t);return e.registerRequestHandler("backupClipboardData",i=>{this._initData.type==="newFromClipboard"&&(this._initData.data=i)}),e.registerRequestHandler("historyNewEdit",i=>{this._editIndex++,this._onDidChange.fire({document:this,label:i.label,redo:()=>l(this,void 0,void 0,function*(){if(this._editIndex++,!(yield e.request("luna.executeCommand","edit.redo")).success)throw new Error(`Could not redo entry "${i.label}"`)}),undo:()=>l(this,void 0,void 0,function*(){if(this._editIndex--,!(yield e.request("luna.executeCommand","edit.undo")).success)throw new Error(`Could not undo entry "${i.label}"`)})})}),e.registerRequestHandler("inputBoxNumber",i=>l(this,void 0,void 0,function*(){let n=yield u.window.showInputBox({prompt:i.prompt,value:i.defaultValue.toString(),validateInput:s=>fe(s,i.minValue,i.maxValue)});return n===void 0?void 0:parseInt(n)})),e.registerRequestHandler("inputBoxNumberOrDimensionsShorthand",i=>l(this,void 0,void 0,function*(){let n=yield u.window.showInputBox({prompt:i.prompt,value:i.defaultValue.toString(),validateInput:s=>{if(!Me(s))return fe(s,i.minValue,i.maxValue)}});if(n==null?void 0:n.includes("x")){let s=n.split("x");return{width:parseInt(s[0]),height:parseInt(s[1])}}return n===void 0?void 0:parseInt(n)})),e.registerRequestHandler("inputBoxString",i=>l(this,void 0,void 0,function*(){return yield u.window.showInputBox({prompt:i.prompt,value:i.defaultValue})})),e.registerRequestHandler("quickPick",i=>l(this,void 0,void 0,function*(){var n;return(n=yield u.window.showQuickPick(i.items,i.options))===null||n===void 0?void 0:n.id})),e.registerRequestHandler("vscode.executeCommand",i=>l(this,void 0,void 0,function*(){return u.commands.executeCommand(i.command,i.args)})),e.registerRequestHandler("vscode.setContext",i=>l(this,void 0,void 0,function*(){yield he(i.key,i.value)})),e.registerRequestHandler("ready",()=>l(this,void 0,void 0,function*(){this._perfMetrics.webviewReadyEvent=g.perf.now();let i;if(!i&&this._workbenchState.size>0){i={version:3,entries:[]};for(let[n,s]of this._workbenchState.entries())i.entries.push({id:n,state:s});(0,ue.mixinGlobalState)(this._context,i)}if(i||(i=(0,ue.getWorkbenchState)(this._context,this.uri)),this._latestBackupUri){let n;if(this._latestBackupContent)n=this._latestBackupContent;else{let s=yield(0,re.getBackupData)(this._context,this._latestBackupUri);n=s.state,i=s.workbenchState}if(!n||n.version<8)u.window.showWarningMessage("Extension was updated, could not restore image from backup");else return this._perfMetrics.dataReadyEvent=g.perf.now(),{type:"restore",config:this._getLunaConfig(),state:n,workbenchState:i,editIndex:this._editIndex,restoreHistory:!0}}if(!this._isInitialized)return this._isInitialized=!0,this._initData.workbenchState=i,this._perfMetrics.dataReadyEvent=g.perf.now(),this._initData;try{let n=yield u.workspace.fs.readFile(this.uri);if(this._lastSaveStat=u.workspace.fs.stat(this.uri),yield this._lastSaveStat,n.length===0){let s=u.workspace.getConfiguration("luna.defaultImageSize",this.uri);return this._perfMetrics.dataReadyEvent=g.perf.now(),{type:"new",config:this._getLunaConfig(),workbenchState:i,dimensions:{width:s.get("width",800),height:s.get("height",600)}}}return this._perfMetrics.dataReadyEvent=g.perf.now(),{type:"open",config:this._getLunaConfig(),workbenchState:i,data:n,extName:(0,Re.extname)(this.uri.path),isReadonly:this._initData.isReadonly}}catch{return u.window.showInformationMessage("This image could not be restored from hot exit, try saving the file and/or turning the luna.retainContextWhenHidden setting on"),this._initData.workbenchState=i,this._perfMetrics.dataReadyEvent=g.perf.now(),this._initData}})),e.registerRequestHandler("parseFinished",i=>l(this,void 0,void 0,function*(){this._perfMetrics.parseDuration=i.duration,this._perfMetrics.finishEvent=g.perf.now(),this._perfMetrics.dataTransportDuration=this._perfMetrics.finishEvent-this._perfMetrics.dataReadyEvent-this._perfMetrics.parseDuration,this._perfMetrics.totalDuration=this._perfMetrics.finishEvent-this._perfMetrics.startEvent,pe(`Open perf: ${this.uri.fsPath}`,this._perfMetrics)})),e.registerRequestHandler("reportIssue",()=>l(this,void 0,void 0,function*(){u.commands.executeCommand("workbench.action.openIssueReporter",{extensionId:"tyriar.luna-paint"})})),e.registerRequestHandler("setMimeType",i=>{this._onMimeTypeChange.fire(i)}),e.registerRequestHandler("updateWorkbenchState",i=>{i.global?this._globalState.set(i.id,i.state):this._workbenchState.set(i.id,i.state);let n=this._context.workspaceState.get("workbenchState")||{},s={version:3,entries:[]};if(i.global){for(let[a,d]of this._globalState.entries())s.entries.push({id:a,state:d});n.global=s}else{for(let[a,d]of this._workbenchState.entries())s.entries.push({id:a,state:d});n[this.uri.toString()]=s}this._context.workspaceState.update("workbenchState",n),i.global&&this._onDidUpdateGlobalState.fire(s)}),e}syncGlobalState(t,e){return l(this,void 0,void 0,function*(){yield t.request("syncGlobalState",e)})}_getLunaConfig(){var t,e,i;let n=u.workspace.getConfiguration();return{mouseWheelBehavior:(t=n.get("luna.mouseWheelBehavior"))!==null&&t!==void 0?t:"scroll",snapToPixelGrid:(e=n.get("luna.snapToPixelGrid"))!==null&&e!==void 0?e:!0,statusBarPointerColor:(i=n.get("luna.statusBar.pointerColor"))!==null&&i!==void 0?i:"currentLayer"}}};w.ImageDocument=de;var le;(function(o){o.SetContext="setContext"})(le=w.BuiltInCommands||(w.BuiltInCommands={}));function he(o,t){return u.commands.executeCommand(le.SetContext,o,t)}w.setVscodeContext=he;function Me(o,t,e){return!!o.match(/^\d+x\d+/)}function fe(o,t,e){if(!o.match(/^[0-9]+$/))return"Enter a valid number";if(t!==void 0&&parseInt(o)<t)return`Enter a number greater than or equal to ${t}`;if(e!==void 0&&parseInt(o)>e)return`Enter a number less than or equal to ${e}`}function Ae(o,t){return t?o.ctime===t.ctime&&o.mtime===t.mtime&&o.size===t.size:!1}function pe(o,t){if(u.workspace.getConfiguration().get("luna.developer.logPerfMetrics")){let i={},n={};for(let s of Object.keys(t)){let a=t[s];s.endsWith("Event")?i[s]={"Time (ms)":parseFloat((a-t.startEvent).toFixed(2)),"Percent (%)":Math.round((t[s]-t.startEvent)/t.totalDuration*100)}:n[s]={"Duration (ms)":parseFloat(a.toFixed(2))}}console.info(`
${o}`),console.table(n),console.table(i)}}});var _e=b(_=>{"use strict";var v=_&&_.__awaiter||function(o,t,e,i){function n(s){return s instanceof e?s:new e(function(a){a(s)})}return new(e||(e=Promise))(function(s,a){function d(c){try{h(i.next(c))}catch(p){a(p)}}function f(c){try{h(i.throw(c))}catch(p){a(p)}}function h(c){c.done?s(c.value):n(c.value).then(d,f)}h((i=i.apply(o,t||[])).next())})};Object.defineProperty(_,"__esModule",{value:!0});_.setVscodeContext=_.BuiltInCommands=_.PaintEditorProvider=void 0;var q=require("path"),r=require("vscode"),E=me(),ve=require("os"),Ue=F(),M=B(),A=W(),je=H(),Pe=["adjustments.invert","color.swapColors","edit.copy","edit.cut","edit.paste","edit.redo","edit.undo","help.reportIssue","image.cropToSelection","image.expandCanvasToSelection","image.resize","image.canvasSize","image.flipHorizontal","image.flipVertical","image.rotate180","image.rotate90Clockwise","image.rotate90CounterClockwise","image.flattenLayers","image.finishActiveAction","image.customizePointerColorStatusBarItem","image.addNewImage","image.deleteImage","image.goToTopImage","image.goToImageAbove","image.goToImageBelow","image.goToBottomImage","image.moveImageToTop","image.moveImageUp","image.moveImageDown","image.moveImageToBottom","layer.addNewLayer","layer.deleteLayer","layer.duplicateLayer","layer.mergeLayerDown","layer.renameLayer","layer.flipHorizontal","layer.flipVertical","layer.rotate180","layer.goToTopLayer","layer.goToLayerAbove","layer.goToLayerBelow","layer.goToBottomLayer","layer.moveLayerToTop","layer.moveLayerUp","layer.moveLayerDown","layer.moveLayerToBottom","selection.deselect","selection.selectAll","selection.erase","selection.eraseKeepSelection","tool.colorPicker","tool.crop","tool.eraser","tool.fill","tool.hand","tool.handUntilRelease","tool.pencil","tool.selection","tool.zoom","tool.line","tool.rectangle","tool.shape","tool.text","tool.toggleShapeTool","tool.movePixels","tool.moveSelection","tool.toggleMoveTool","view.focusCanvas","view.zoomIn","view.zoomOut","view.actualSize","view.fitToWindow","view.fitLayerToWindow","color.toggleColorsWindow","history.toggleHistoryWindow","image.toggleImagesWindow","layer.toggleLayersWindow","minimap.toggleMinimapWindow","palette.togglePaletteWindow","tool.toggleToolsWindow"],I=class{constructor(t){this._context=t,this._onDidChangeCustomDocument=new r.EventEmitter,this.onDidChangeCustomDocument=this._onDidChangeCustomDocument.event,this._documents=new Map,this._webviewPanels=new Map,this._webviewIpcClients=new Map,this._newImageRequest=new Map;for(let e of Pe)this._context.subscriptions.push(r.commands.registerCommand(`luna.${e}`,()=>{if(!this._lastActiveResource)return;let i=this._webviewIpcClients.get(this._lastActiveResource.toString());if(!!i)return i.request("luna.executeCommand",e)}));this._context.subscriptions.push(r.commands.registerCommand("luna.file.new",e=>v(this,void 0,void 0,function*(){let i=r.workspace.getConfiguration("luna.defaultImageSize",this._lastActiveResource),n={width:i.get("width",800),height:i.get("height",600)},s=yield this._requestNewImageDimensions(n,e);if(!s)return;let a=yield this._getNewImageUri();this._newImageRequest.set(a.path,{width:s.width,height:s.height}),r.commands.executeCommand("vscode.openWith",a,I.viewType)}))),r.workspace.onDidChangeConfiguration(e=>{if(e.affectsConfiguration("luna")){let i=this._getLunaConfig();for(let n of this._webviewIpcClients.values())n.request("updateConfig",i)}}),this._context.subscriptions.push(r.commands.registerCommand("luna.file.newIcon",e=>v(this,void 0,void 0,function*(){let i={width:256,height:256},n=yield this._requestNewImageDimensions(i,e);if(!n)return;let s=yield this._getNewImageUri("image/x-ico");this._newImageRequest.set(s.path,{width:n.width,height:n.height,extName:".ico"}),r.commands.executeCommand("vscode.openWith",s,I.viewType)}))),this._context.subscriptions.push(r.commands.registerCommand("luna.file.importFromClipboard",()=>v(this,void 0,void 0,function*(){let e=yield this._getNewImageUri();this._newImageRequest.set(e.path,"clipboard"),r.commands.executeCommand("vscode.openWith",e,I.viewType)}))),this._context.subscriptions.push(r.commands.registerCommand("luna.file.newDefaultSize",()=>v(this,void 0,void 0,function*(){let e=yield this._getNewImageUri();this._newImageRequest.set(e.path,this._getDefaultImageSize(e)),r.commands.executeCommand("vscode.openWith",e,I.viewType)}))),this._context.subscriptions.push(r.commands.registerCommand("luna.help.openDocumentation",()=>v(this,void 0,void 0,function*(){r.commands.executeCommand("workbench.action.openWalkthrough","Tyriar.luna-paint#exampleProject",!0)}))),this._context.subscriptions.push(r.commands.registerCommand("luna.help.hideAutoSaveWarning",()=>v(this,void 0,void 0,function*(){var e;(e=this._autoSaveWarningStatusBarItem)===null||e===void 0||e.dispose(),this._autoSaveWarningStatusBarItem=void 0}))),this._context.subscriptions.push(r.window.onDidChangeWindowState(e=>{if(!e.focused)for(let i of this._webviewIpcClients.values())i.request("pauseanimations",void 0)})),this._context.subscriptions.push(r.window.onDidChangeActiveTextEditor(()=>{var e;this._mimeTypeStatusBarItem.hide(),(e=this._autoSaveWarningStatusBarItem)===null||e===void 0||e.hide()})),this._mimeTypeStatusBarItem=r.window.createStatusBarItem("luna-paint.mimeType",r.StatusBarAlignment.Right),this._mimeTypeStatusBarItem.name="Luna Paint - Mime Type",this._autoSaveWarningStatusBarItem=r.window.createStatusBarItem("luna-paint.autoSaveWarning",r.StatusBarAlignment.Right),this._autoSaveWarningStatusBarItem.name="Luna Paint - Auto Save Warning",this._autoSaveWarningStatusBarItem.text="$(warning) Auto Save is On",this._autoSaveWarningStatusBarItem.backgroundColor=new r.ThemeColor("statusBarItem.warningBackground"),this._autoSaveWarningStatusBarItem.color=new r.ThemeColor("statusBarItem.warningForeground"),this._autoSaveWarningStatusBarItem.tooltip="Auto save after delay is enabled which may cause performance issues while editing the image. Click to dismiss this warning for this session, right click to hide it permanently.",this._autoSaveWarningStatusBarItem.command="luna.help.hideAutoSaveWarning"}saveCustomDocument(t,e){return v(this,void 0,void 0,function*(){let i=this._webviewIpcClients.get(t.uri.toString());return i?t.save(i,e):Promise.reject("No matching webview")})}saveCustomDocumentAs(t,e,i){return v(this,void 0,void 0,function*(){let n=this._webviewIpcClients.get(t.uri.toString());if(!n)return Promise.reject("No matching webview");yield t.saveAs(n,e,i)})}revertCustomDocument(t,e){return v(this,void 0,void 0,function*(){let i=this._webviewIpcClients.get(t.uri.toString());if(!i)return Promise.reject("No matching webview");let n=yield r.workspace.fs.readFile(t.uri);t.revert(),yield i.request("open",{data:n,extName:(0,q.extname)(t.uri.path)})})}backupCustomDocument(t,e,i){return v(this,void 0,void 0,function*(){let n=this._webviewIpcClients.get(t.uri.toString());if(!n)return Promise.reject("No matching webview");try{return yield t.backup(n,e,i)}catch(s){throw console.error("Backup failed",s),s}})}openCustomDocument(t,e,i){return v(this,void 0,void 0,function*(){let n;if(n=this._documents.get(t.toString()),n)return n;if(e.backupId){let a=r.Uri.parse(e.backupId);try{let{state:d,workbenchState:f}=yield(0,Ue.getBackupData)(this._context,a);d?n=new E.ImageDocument(this._context,t,{type:"restore",config:this._getLunaConfig(),state:d,workbenchState:f,restoreHistory:!1}):(r.window.showWarningMessage("The extension was updated, could not restore the image from backup"),n=yield this._createOpenImageDocument(t))}catch{n=yield this._createOpenImageDocument(t)}}else{let a=this._newImageRequest.get(t.path);a?(a==="clipboard"?n=new E.ImageDocument(this._context,t,{type:"newFromClipboard",config:this._getLunaConfig(),workbenchState:(0,A.getGlobalState)(this._context),fallbackDimensions:this._getDefaultImageSize(t)}):n=new E.ImageDocument(this._context,t,{type:"new",config:this._getLunaConfig(),workbenchState:(0,A.getGlobalState)(this._context),dimensions:{width:a.width,height:a.height},extName:a.extName}),this._newImageRequest.delete(t.path)):n=yield this._createOpenImageDocument(t)}n.onDidChange(a=>this._onDidChangeCustomDocument.fire(a));let s=n;return n.onDidUpdateGlobalState(a=>this._syncGlobalState(a,s)),n.onSetMimeType(a=>{this._mimeTypeStatusBarItem.text=ze(a),this._mimeTypeStatusBarItem.tooltip=a,this._mimeTypeStatusBarItem.show()}),this._documents.set(t.toString(),n),n.onDisposed(()=>this._documents.delete(t.toString())),n})}_syncGlobalState(t,e){if(this._documents.size!==1)for(let i of this._documents.values()){if(i===e)continue;let n=this._webviewIpcClients.get(i.uri.toString());if(!n)return;i.syncGlobalState(n,t)}}_getNewImageUri(t="image/png"){return v(this,void 0,void 0,function*(){let e=r.workspace.workspaceFolders,i;if(e&&e.length>0)i=e[0].uri;else{let s;if(M.isWindows&&!M.isWeb&&process.env.USERPROFILE?s=(0,q.join)(process.env.USERPROFILE,"Pictures"):(M.isMac||M.isLinux)&&(s=(0,q.join)((0,ve.homedir)(),"Pictures")),s){let a=r.Uri.from({scheme:this._context.extensionUri.scheme,path:s});try{yield r.workspace.fs.stat(a)}catch{s=void 0}}i=r.Uri.from({scheme:this._context.extensionUri.scheme,path:s||(0,ve.homedir)()})}let n=t==="image/x-ico"?"ico":"png";return r.Uri.joinPath(i,`NewImage-${this._getUnusedNewImageId()}.${n}`).with({scheme:"untitled"})})}_getUnusedNewImageId(){let e=Array.from(this._documents.values()).map(n=>n.uri).map(n=>(0,q.parse)(n.path).name).filter(n=>n.match(/^NewImage-\d+$/)).map(n=>parseInt(n.substring(9))),i=1;for(;e.includes(i);)i++;return i}_requestNewImageDimensions(t,e){return v(this,void 0,void 0,function*(){let i=(e==null?void 0:e.width)||(yield r.window.showInputBox({prompt:"Enter the width of the image",value:t.width.toString(),validateInput:we}));if(!i)return;let n=(e==null?void 0:e.height)||(yield r.window.showInputBox({prompt:"Enter the height of the image",value:t.height.toString(),validateInput:we}));if(!!n)return{width:typeof i=="number"?i:parseInt(i),height:typeof n=="number"?n:parseInt(n)}})}_createOpenImageDocument(t){return v(this,void 0,void 0,function*(){try{let e=je.perf.now(),i=new Uint8Array(yield r.workspace.fs.readFile(t));if(i.length>0)return new E.ImageDocument(this._context,t,{type:"open",config:this._getLunaConfig(),workbenchState:(0,A.getGlobalState)(this._context),data:i,extName:(0,q.extname)(t.path),isReadonly:!r.workspace.fs.isWritableFileSystem(t.scheme)},e)}catch{}return new E.ImageDocument(this._context,t,{type:"new",config:this._getLunaConfig(),workbenchState:(0,A.getGlobalState)(this._context),dimensions:this._getDefaultImageSize(t)})})}_getDefaultImageSize(t){let e=r.workspace.getConfiguration("luna.defaultImageSize",t);return{width:e.get("width",800),height:e.get("height",600)}}resolveCustomEditor(t,e,i){let n=this._webviewPanels.get(t.uri.toString());n==null||n.dispose(),this._webviewPanels.set(t.uri.toString(),e);let s=e.webview;s.options={enableScripts:!0},s.html=this._getHtml(s);let a=t.setupIpc(s);this._webviewIpcClients.set(t.uri.toString(),a),t.onRequestReload(()=>v(this,void 0,void 0,function*(){let d=yield r.workspace.fs.readFile(t.uri);yield a.request("open",{data:d,extName:(0,q.extname)(t.uri.path)})})),e.onDidChangeViewState(()=>this._refreshActiveState(t,e)),e.onDidDispose(()=>this._handleWebviewBlur(t)),this._refreshActiveState(t,e),e.reveal()}_refreshActiveState(t,e){var i;e.active?(this._lastActiveResource=t.uri,this._mimeTypeStatusBarItem.show(),r.workspace.getConfiguration("files",this._lastActiveResource).get("autoSave")==="afterDelay"&&((i=this._autoSaveWarningStatusBarItem)===null||i===void 0||i.show()),O("luna:focused",e.active)):this._handleWebviewBlur(t),t.isActive=e.active}_getLunaConfig(){var t,e,i;let n=r.workspace.getConfiguration(void 0,this._lastActiveResource);return{mouseWheelBehavior:(t=n.get("luna.mouseWheelBehavior"))!==null&&t!==void 0?t:"scroll",snapToPixelGrid:(e=n.get("luna.snapToPixelGrid"))!==null&&e!==void 0?e:!0,statusBarPointerColor:(i=n.get("luna.statusBar.pointerColor"))!==null&&i!==void 0?i:"currentLayer"}}_handleWebviewBlur(t){var e;this._lastActiveResource===t.uri&&(this._mimeTypeStatusBarItem.hide(),(e=this._autoSaveWarningStatusBarItem)===null||e===void 0||e.hide(),O("luna:focused",!1))}_getHtml(t){let e=t.asWebviewUri(r.Uri.joinPath(this._context.extensionUri,"luna/dist/vscode.main.js")),i=t.asWebviewUri(r.Uri.joinPath(this._context.extensionUri,"luna/dist/vscode.main.css")),n=t.cspSource;return`
<!doctype html>
<html lang="en-US">
  <head>
    <title>Luna Paint</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' ${n}; style-src-elem 'self' ${n}; worker-src ${n};">
    <link rel="stylesheet" href="${i}">
  </head>
  <body>
    <div id="top"></div>
    <div id="middle">
      <div id="canvas"></div>
      <div id="gui"></div>
    </div>
    <div id="bottom"></div>
    <script type="module" src="${e}" defer><\/script>
  </body>
</html>`}};_.PaintEditorProvider=I;I.viewType="luna.editor";var ge;(function(o){o.SetContext="setContext"})(ge=_.BuiltInCommands||(_.BuiltInCommands={}));function O(o,t){return r.commands.executeCommand(ge.SetContext,o,t)}_.setVscodeContext=O;function we(o,t,e){if(!o.match(/^[0-9]+$/))return"Enter a valid number";if(t!==void 0&&parseInt(o)<t)return`Enter a number greater than or equal to ${t}`;if(e!==void 0&&parseInt(o)>e)return`Enter a number less than or equal to ${e}`}function ze(o){switch(o){case"image/bmp":return"BMP";case"image/x-ico":return"ICO";case"image/jpeg":return"JPEG";case"image/png":return"PNG";case"image/webp":case"image/webplossless":return"WEBP"}}});"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.deactivate=exports.activate=void 0;var ye=require("vscode"),be=_e();function Le(o){let t=ye.workspace.getConfiguration("luna").get("retainContextWhenHidden");o.subscriptions.push(ye.window.registerCustomEditorProvider(be.PaintEditorProvider.viewType,new be.PaintEditorProvider(o),{webviewOptions:{retainContextWhenHidden:t}}))}exports.activate=Le;function Fe(){}exports.deactivate=Fe;
